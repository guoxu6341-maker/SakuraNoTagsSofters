<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sakura No Tagsofter å–µ</title>
    <style>
        :root {
            --bg-dark: #0b0c15;
            --glass-bg: rgba(20, 25, 40, 0.75);
            --glass-border: rgba(150, 200, 255, 0.15);
            --neon-blue: #64d2ff;
            --neon-pink: #ff64e3;
            --neon-purple: #9f86ff;
            --text-main: #ffffff;
            --text-sub: #a0a8c0;
            --sidebar-width: 220px;
        }

        body { margin: 0; padding: 0; font-family: 'Segoe UI', 'Roboto', monospace; background-color: #000000; background-image: linear-gradient(to bottom, #0b0c15 0%, #000000 100%); color: var(--text-main); min-height: 100vh; overflow-y: hidden; }
        .bg-decoration { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; background: radial-gradient(circle at 50% 30%, rgba(26, 31, 53, 0.8) 0%, transparent 50%); }
        .snow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; pointer-events: none; }
        .snowflake { position: absolute; top: -10px; background: white; border-radius: 50%; opacity: 0.8; filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5)); }
        @keyframes snowFall { 0% { transform: translateY(-10vh) translateX(0) rotate(0deg); } 100% { transform: translateY(110vh) translateX(20px) rotate(360deg); } }

        .navbar { display: flex; justify-content: space-between; align-items: center; height: 60px; padding: 0 20px; background: rgba(11, 12, 21, 0.9); border-bottom: 1px solid var(--glass-border); backdrop-filter: blur(10px); position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; box-sizing: border-box; }
        .logo { font-size: 1.5rem; font-weight: 800; background: linear-gradient(90deg, #ffb6c1, #ff64e3); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 2px; text-shadow: 0 0 20px rgba(255, 100, 227, 0.3); }
        .nav-tabs { display: flex; gap: 10px; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 8px; }
        .nav-item { padding: 8px 20px; cursor: pointer; border-radius: 6px; font-size: 0.9rem; font-weight: 600; color: var(--text-sub); transition: all 0.3s; }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-item.active { background: var(--neon-purple); color: black; box-shadow: 0 0 15px rgba(159, 134, 255, 0.4); }

        .main-container { margin-top: 60px; height: calc(100vh - 60px); position: relative; }
        .page-view { display: none; height: 100%; overflow-y: auto; padding: 20px; box-sizing: border-box; animation: fadeIn 0.3s ease; }
        .page-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .glass-panel { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; padding: 20px; backdrop-filter: blur(15px); }
        textarea { width: 100%; background: rgba(0,0,0,0.4); border: 1px solid #333; border-radius: 6px; padding: 15px; color: #dbeafe; font-family: monospace; resize: vertical; outline: none; box-sizing: border-box; min-height: 150px; }
        textarea:focus { border-color: var(--neon-pink); }
        .btn-frost { background: rgba(255, 100, 227, 0.1); border: 1px solid var(--neon-pink); color: var(--neon-pink); padding: 8px 25px; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-frost:hover { background: var(--neon-pink); color: black; box-shadow: 0 0 15px var(--neon-pink); }

        /* Sorter */
        .sorter-layout { max-width: 1300px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
        .checkbox-wrapper { display: flex; align-items: center; cursor: pointer; color: var(--text-sub); }
        .checkbox-wrapper input { margin-right: 5px; accent-color: var(--neon-pink); }
        .sorter-results-area { margin-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        .category-group { border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; }
        .category-title { color: var(--neon-blue); font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px; padding-bottom: 5px; font-size: 0.95rem; }
        .tags-wrapper { display: flex; flex-wrap: wrap; gap: 8px; }
        
        .sorter-tag-card { background: rgba(100, 255, 218, 0.1); padding: 6px 12px; border-radius: 8px; border: 1px solid rgba(100, 255, 218, 0.3); color: #b9f6ca; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; user-select: none; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 40px; }
        .sorter-tag-card:hover { background: rgba(255, 82, 82, 0.2); border-color: #ff5252; transform: translateY(-2px); }
        .sorter-en { font-weight: bold; line-height: 1.2; }
        .sorter-tag-card:hover .sorter-en { color: #ff8a80; text-decoration: line-through; }
        .sorter-cn { font-size: 0.75rem; opacity: 0.8; margin-top: 2px; color: #69f0ae; }
        .sorter-tag-card:hover .sorter-cn { color: #ff8a80; }
        .sorter-tag-card.excluded { background: rgba(255,255,255,0.05); border-color: transparent; opacity: 0.5; }
        .sorter-tag-card.excluded .sorter-en { text-decoration: line-through; color: #666; }

        /* Browser */
        .browser-layout { display: flex; flex-direction: column; height: 100%; gap: 15px; max-width: 1600px; margin: 0 auto; }
        .builder-box { background: var(--glass-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--glass-border); display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; }
        #builderInput { height: 80px; min-height: 80px; font-size: 1rem; }
        .builder-tools { display: flex; justify-content: space-between; align-items: center; }
        .selected-area { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; min-height: 70px; max-height: 150px; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 8px; align-content: flex-start; transition: all 0.3s; flex-shrink: 0; }
        .selected-area:hover { border-color: var(--neon-blue); box-shadow: 0 0 15px rgba(100, 210, 255, 0.1); }
        .selected-tag-chip { background: rgba(100, 210, 255, 0.1); border: 1px solid var(--neon-blue); border-radius: 8px; padding: 6px 12px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; user-select: none; min-width: 60px; }
        .selected-tag-chip:hover { background: rgba(255, 82, 82, 0.2); border-color: #ff5252; transform: translateY(-2px); }
        .chip-en { font-size: 0.9rem; font-weight: bold; color: #b3e5fc; line-height: 1.2; }
        .selected-tag-chip:hover .chip-en { color: #ff8a80; text-decoration: line-through; }
        .chip-cn { font-size: 0.75rem; color: #ff64e3; opacity: 0.9; margin-top: 2px; }
        .selected-tag-chip:hover .chip-cn { color: #ff8a80; }
        .empty-tip { color: #666; font-size: 0.9rem; padding: 5px; font-style: italic; }

        .dict-container { flex: 1; display: flex; flex-direction: column; background: var(--glass-bg); border-radius: 12px; border: 1px solid var(--glass-border); overflow: hidden; min-height: 0; }
        .search-container { padding: 10px 15px; background: rgba(0,0,0,0.4); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; gap: 10px; }
        #searchInput { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 12px; color: white; font-size: 0.95rem; outline: none; }
        #searchInput:focus { border-color: var(--neon-blue); box-shadow: 0 0 10px rgba(100, 210, 255, 0.2); }
        .search-btn { background: var(--neon-purple); color: black; border: none; padding: 0 20px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .search-btn:hover { filter: brightness(1.2); }
        .add-btn { background: rgba(105, 240, 174, 0.2); color: #69f0ae; border: 1px solid #69f0ae; padding: 0 20px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-left: 10px; }
        .add-btn:hover { background: #69f0ae; color: black; }

        .major-tabs-scroll { display: flex; gap: 5px; padding: 10px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); overflow-x: auto; white-space: nowrap; background: rgba(0,0,0,0.3); flex-shrink: 0; align-items: center; }
        .major-tab { padding: 8px 16px; border-radius: 4px; cursor: pointer; color: var(--text-sub); font-weight: 600; font-size: 0.95rem; transition: 0.2s; border-bottom: 2px solid transparent; user-select: none; }
        .major-tab:hover { color: white; background: rgba(255,255,255,0.05); }
        .major-tab.active { color: var(--neon-blue); border-bottom-color: var(--neon-blue); background: rgba(100, 210, 255, 0.1); }
        .major-tab.dragging { opacity: 0.5; border: 2px dashed var(--neon-pink); background: rgba(255,255,255,0.1); }
        .major-tab-add { padding: 8px 12px; border-radius: 4px; cursor: pointer; color: #69f0ae; font-weight: bold; border: 1px dashed #69f0ae; margin-left: 10px; transition: 0.2s; }
        .major-tab-add:hover { background: rgba(105, 240, 174, 0.2); color: white; }

        .dict-content { display: flex; flex: 1; overflow: hidden; }
        .minor-sidebar { width: var(--sidebar-width); background: rgba(0,0,0,0.2); border-right: 1px solid rgba(255,255,255,0.1); overflow-y: auto; padding: 10px 0; flex-shrink: 0; }
        .minor-item { padding: 10px 20px; cursor: pointer; font-size: 0.9rem; color: #ccc; border-left: 3px solid transparent; transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; user-select: none; }
        .minor-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .minor-item.active { border-left-color: var(--neon-pink); background: linear-gradient(90deg, rgba(255,100,227,0.1), transparent); color: var(--neon-pink); font-weight: bold; }
        .minor-item-add { padding: 10px 20px; cursor: pointer; font-size: 0.9rem; color: #69f0ae; border-left: 3px solid transparent; transition: 0.2s; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .minor-item-add:hover { background: rgba(105, 240, 174, 0.1); }

        .tags-grid-area { flex: 1; overflow-y: auto; padding: 20px; background: rgba(0,0,0,0.1); }
        .section-title { font-size: 1.1rem; color: var(--neon-pink); margin-bottom: 15px; font-weight: bold; border-bottom: 1px solid rgba(255,100,227,0.3); padding-bottom: 5px; }
        .tags-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; padding-bottom: 20px; }

        .dict-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px 12px; cursor: pointer; display: flex; flex-direction: column; gap: 6px; transition: all 0.2s ease; position: relative; overflow: hidden; min-height: 50px; justify-content: center; }
        .dict-card:hover { border-color: var(--neon-blue); background: rgba(100, 210, 255, 0.15); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        .dict-card:active { transform: scale(0.98); }
        .dict-en { font-size: 0.95rem; color: #fff; font-weight: 600; word-break: break-word; line-height: 1.2; }
        .dict-cn { font-size: 0.8rem; color: var(--neon-pink); margin-top: auto; opacity: 0.9; font-weight: normal; }
        .dict-cn.empty { opacity: 0.3; font-style: italic; font-size: 0.75rem; }
        .dict-card.user-custom { border: 1px dashed #ffd700; background: rgba(255, 215, 0, 0.05); }
        .dict-card.user-custom .dict-cn { color: #ffd700; }

        /* å¼¹çª— */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 2000; justify-content: center; align-items: center; animation: fadeIn 0.2s ease; }
        .modal-overlay.show { display: flex; }
        .modal-box { background: #1a1b26; border: 1px solid var(--neon-purple); border-radius: 12px; width: 450px; padding: 20px; box-shadow: 0 0 30px rgba(159, 134, 255, 0.3); position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; color: var(--neon-purple); }
        .modal-close { font-size: 1.5rem; cursor: pointer; color: #888; transition: 0.2s; }
        .modal-close:hover { color: white; }
        .modal-body { display: flex; flex-direction: column; gap: 15px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; flex: 1; }
        .form-group label { font-size: 0.85rem; color: #aaa; }
        .form-group input { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); padding: 10px; border-radius: 6px; color: white; outline: none; }
        .form-group input:focus { border-color: var(--neon-purple); }
        .form-group input:read-only { opacity: 0.5; cursor: not-allowed; }
        .form-row { display: flex; gap: 15px; }
        .modal-footer { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }
        .btn-cancel { background: transparent; border: 1px solid #555; color: #ccc; padding: 8px 20px; border-radius: 6px; cursor: pointer; }
        .btn-cancel:hover { border-color: white; color: white; }
        .btn-save { background: var(--neon-purple); border: none; color: black; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-save:hover { filter: brightness(1.2); }

        /* å³é”®èœå• */
        #contextMenu { display: none; position: absolute; background: #1a1b26; border: 1px solid var(--neon-blue); border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 3000; overflow: hidden; min-width: 120px; }
        .ctx-item { padding: 10px 20px; cursor: pointer; color: #eee; font-size: 0.9rem; transition: 0.2s; }
        .ctx-item:hover { background: var(--neon-blue); color: black; }
        .ctx-item.delete { color: #ff5252; }
        .ctx-item.delete:hover { background: #ff5252; color: white; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-pink); }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body>

<div class="bg-decoration"></div>
<div class="snow-container" id="snowContainer"></div>

<div class="navbar">
    <div class="logo">SAKURA TAGS <span style="font-size:0.8rem; color:#aaa; font-weight:normal;">(ç§æœ‰ç‰ˆ)</span></div>
    <div class="nav-tabs">
        <div class="nav-item active" onclick="switchPage('sorter')">æ™ºèƒ½æ•´ç† (Sorter)</div>
        <div class="nav-item" onclick="switchPage('browser')">æ ‡ç­¾å­—å…¸ (Browser)</div>
    </div>
</div>

<div class="main-container">
    <div id="page-sorter" class="page-view active">
        <div class="sorter-layout">
            <div class="glass-panel">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="color:var(--neon-pink); font-weight:bold;">INPUT PROMPTS</span>
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="deduplicate" checked> å»é‡ (Deduplicate)
                    </label>
                </div>
                <textarea id="inputTags" placeholder="ç²˜è´´ä½ çš„ Tag å’’è¯­... (ä¾‹å¦‚: 1girl, solo, white dress...)"></textarea>
                <div style="text-align:right; margin-top:10px;">
                    <button class="btn-frost" onclick="processTags()" id="runBtn">å¼€å§‹æ•´ç† (SORT)</button>
                </div>
            </div>
            <div class="glass-panel">
                <div style="color:var(--neon-pink); font-weight:bold; margin-bottom:10px;">SORTED OUTPUT (ç‚¹å‡»å¡ç‰‡å¯åˆ é™¤)</div>
                <textarea id="outputText" placeholder="æ•´ç†åçš„ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
                <div id="sorterAnalysis" class="sorter-results-area"></div> 
            </div>
        </div>
    </div>

    <div id="page-browser" class="page-view">
        <div class="browser-layout">
            <div class="builder-box">
                <textarea id="builderInput" placeholder="åœ¨æ­¤å¤„è¾“å…¥æˆ–ç‚¹å‡»ä¸‹æ–¹æ·»åŠ ..."></textarea>
                <div class="builder-tools">
                    <span style="color:#666; font-size:0.8rem;">æç¤ºï¼šç‚¹å‡»å¡ç‰‡æ·»åŠ ï¼Œåœ¨ä¸‹æ–¹çº¢æ¡†åŒºåŸŸç‚¹å‡»æ ‡ç­¾å¯åˆ é™¤ã€‚</span>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-frost" onclick="clearBuilder()">æ¸…ç©º</button>
                        <button class="btn-frost" onclick="copyBuilder()">å¤åˆ¶</button>
                    </div>
                </div>
            </div>
            <div class="selected-area" id="selectedTagsDisplay">
                <div class="empty-tip">å·²é€‰æ ‡ç­¾å°†æ˜¾ç¤ºåœ¨è¿™é‡Œï¼Œç‚¹å‡»å³å¯åˆ é™¤...</div>
            </div>
            <div class="dict-container">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢æ ‡ç­¾ (æ”¯æŒä¸­æ–‡/è‹±æ–‡)...">
                    <button class="search-btn" onclick="performSearch()">æœç´¢</button>
                    <button class="add-btn" onclick="openModal('add_tag')">+ æ–°å¢ Tag</button>
                </div>
                <div class="major-tabs-scroll" id="majorTabsContainer"></div>
                <div class="dict-content">
                    <div class="minor-sidebar" id="minorSidebar"></div>
                    <div class="tags-grid-area">
                        <div class="section-title" id="currentSectionTitle">è¯·é€‰æ‹©åˆ†ç±»</div>
                        <div class="tags-grid" id="tagsGrid">
                            <div style="color:#666; grid-column:1/-1; text-align:center;">è¯·åœ¨å·¦ä¾§é€‰æ‹©åˆ†ç±»...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¼¹çª— -->
<div id="editModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3 id="modalTitle">âœ¨ æ–°å¢ / ä¿®æ”¹ Tag</h3>
            <span class="modal-close" onclick="closeModal()">Ã—</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>å¤§ç±» (Major)</label>
                <input type="text" id="modalCat" list="catList" placeholder="é€‰æ‹©æˆ–è¾“å…¥æ–°åˆ†ç±»">
                <datalist id="catList"></datalist>
            </div>
            <div class="form-group">
                <label>å°ç±» (Minor)</label>
                <input type="text" id="modalSub" list="subList" placeholder="é€‰æ‹©æˆ–è¾“å…¥æ–°å­ç±»">
                <datalist id="subList"></datalist>
            </div>
            <div style="border-top:1px solid rgba(255,255,255,0.1); margin:10px 0;"></div>
            <p style="color:#69f0ae; font-size:0.8rem; margin:0;">âš ï¸ åˆ›å»ºæ–°åˆ†ç±»æ—¶ï¼Œå¿…é¡»æ·»åŠ è¯¥åˆ†ç±»ä¸‹çš„ç¬¬ä¸€ä¸ª Tagã€‚</p>
            <div class="form-group">
                <label>è‹±æ–‡ Tag (å¿…å¡«)</label>
                <input type="text" id="modalTag" placeholder="ä¾‹å¦‚: white dress">
            </div>
            <div class="form-group">
                <label>ä¸­æ–‡ç¿»è¯‘</label>
                <input type="text" id="modalTrans" placeholder="ä¾‹å¦‚: ç™½è‰²è¿è¡£è£™">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn-save" onclick="saveTagDataLocal()">ä¿å­˜åˆ°æœ¬åœ°</button>
        </div>
    </div>
</div>

<!-- å³é”®èœå• -->
<div id="contextMenu"></div>

<script>
    // === æœ¬åœ°å­˜å‚¨æ ¸å¿ƒé€»è¾‘ ===
    const STORAGE_KEY_TAGS = 'my_custom_tags';
    const STORAGE_KEY_DELETED = 'my_deleted_tags';

    function getLocalData() {
        return {
            added: JSON.parse(localStorage.getItem(STORAGE_KEY_TAGS) || '[]'),
            deleted: JSON.parse(localStorage.getItem(STORAGE_KEY_DELETED) || '[]')
        };
    }

    window.addEventListener('load', () => {
        createSnow();
        loadGlobalConfig();
        const input = document.getElementById('builderInput');
        input.addEventListener('input', syncTagsFromInput);
        document.getElementById('searchInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') performSearch();
        });
        document.getElementById('modalCat').addEventListener('input', updateSubList);
        document.addEventListener('click', () => {
            document.getElementById('contextMenu').style.display = 'none';
        });
    });

    function createSnow() {
        const container = document.getElementById('snowContainer');
        for (let i = 0; i < 50; i++) {
            const flake = document.createElement('div');
            flake.classList.add('snowflake');
            const size = Math.random() * 3 + 1 + 'px';
            flake.style.width = size; flake.style.height = size;
            flake.style.left = Math.random() * 100 + 'vw';
            flake.style.opacity = Math.random() * 0.5 + 0.1;
            flake.style.animation = `snowFall ${Math.random() * 10 + 10}s linear infinite`;
            flake.style.animationDelay = '-' + Math.random() * 10 + 's';
            container.appendChild(flake);
        }
    }

    let globalConfig = { mapping: [], order: [] }; 
    let dictionaryStructure = {}; 
    let fullDictionaryStructure = {}; 
    let translationCache = {}; 
    let currentMajor = null;
    let currentMinor = null;
    
    async function loadGlobalConfig() {
        try {
            const res = await fetch('/api/load_config');
            const data = await res.json();
            if(data.status === 'success') {
                globalConfig.mapping = data.mapping;
                globalConfig.order = data.order;
            }
        } catch(e) { console.error("é…ç½®åŠ è½½å¤±è´¥:", e); }
    }

    function switchPage(pageId) {
        document.querySelectorAll('.page-view').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        const navIndex = pageId === 'sorter' ? 0 : 1;
        document.querySelectorAll('.nav-item')[navIndex].classList.add('active');
        if (pageId === 'browser' && Object.keys(dictionaryStructure).length === 0) loadDictionaryStructure();
    }

    // === Sorter é€»è¾‘ ===
    let lastSortedData = {}; 
    async function processTags() {
        const inputStr = document.getElementById('inputTags').value;
        const btn = document.getElementById('runBtn');
        if(!inputStr.trim()) return;
        btn.innerText = "PROCESSING..."; btn.style.opacity = "0.7";
        try {
            const res = await fetch('/api/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    tags: inputStr, 
                    deduplicate: document.getElementById('deduplicate').checked,
                    mapping: globalConfig.mapping,
                    order: globalConfig.order
                })
            });
            const data = await res.json();
            if(data.result_struct) {
                // æ ¸å¿ƒï¼šåœ¨æ¸²æŸ“å‰ï¼ŒæŠŠæœ¬åœ°ç§æœ‰ Tag åˆå¹¶è¿›å»
                lastSortedData = mergeLocalTagsToSorter(data.result_struct); 
                renderSorterResults(lastSortedData); 
                updateSorterOutputText(lastSortedData); 
            }
        } catch(e) { alert("Error: " + e); } 
        finally { btn.innerText = "å¼€å§‹æ•´ç† (SORT)"; btn.style.opacity = "1"; }
    }

    // === æ–°å¢ï¼šå°†æœ¬åœ° Tag åˆå¹¶åˆ° Sorter ç»“æœ ===
    function mergeLocalTagsToSorter(serverResult) {
        const local = getLocalData();
        const defaultCat = "æœªå½’ç±»è¯"; // åç«¯é»˜è®¤åˆ†ç±»å

        // 1. å»ºç«‹æœ¬åœ° Tag æŸ¥æ‰¾è¡¨
        const localLookup = {};
        local.added.forEach(item => {
            localLookup[item.t.toLowerCase()] = { c: item.c, s: item.s, zh: item.zh };
        });

        // 2. æ£€æŸ¥â€œæœªå½’ç±»â€æ¡¶ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰ç§æœ‰ Tag è¢«è¯¯åˆ†åˆ°è¿™é‡Œ
        if (serverResult[defaultCat]) {
            const remainingUncategorized = [];
            
            serverResult[defaultCat].forEach(tagObj => {
                const lowerTag = tagObj.tag.toLowerCase();
                if (localLookup[lowerTag]) {
                    // æ‰¾åˆ°äº†ï¼æ˜¯ç”¨æˆ·çš„ç§æœ‰ Tag
                    const info = localLookup[lowerTag];
                    const targetCat = info.c;

                    if (!serverResult[targetCat]) {
                        serverResult[targetCat] = [];
                    }

                    // ç§»åŠ¨åˆ°æ­£ç¡®åˆ†ç±»ï¼Œå¹¶è¡¥å……ç¿»è¯‘
                    tagObj.trans = info.zh;
                    serverResult[targetCat].push(tagObj);
                } else {
                    remainingUncategorized.push(tagObj);
                }
            });

            // æ›´æ–°æœªå½’ç±»æ¡¶
            serverResult[defaultCat] = remainingUncategorized;
        }

        // 3. æ£€æŸ¥æœ¬åœ° Tag ä¸­æ˜¯å¦æœ‰å…¨æ–°æœªæäº¤çš„ Tag 
        // (æ³¨ï¼šæ­¤é€»è¾‘å¤æ‚ï¼Œæš‚ä¸å®ç°è‡ªåŠ¨è¡¥å…¨ï¼Œåªå¤„ç†è¾“å…¥çš„ Tag)

        return serverResult;
    }

    function renderSorterResults(resultStruct) {
        const analysisDiv = document.getElementById('sorterAnalysis');
        analysisDiv.innerHTML = "";
        const categories = Object.keys(resultStruct);
        let displayOrder = globalConfig.order.length > 0 ? globalConfig.order : categories;
        categories.forEach(c => { if(!displayOrder.includes(c)) displayOrder.push(c); });

        displayOrder.forEach(cat => {
            const tags = resultStruct[cat];
            if (!tags || tags.length === 0) return;
            const groupDiv = document.createElement('div');
            groupDiv.className = 'category-group';
            const title = document.createElement('div');
            title.className = 'category-title';
            title.innerText = `${cat} (${tags.length})`;
            groupDiv.appendChild(title);
            const wrapper = document.createElement('div');
            wrapper.className = 'tags-wrapper';
            tags.forEach((t, index) => {
                const card = document.createElement('div');
                card.className = 'sorter-tag-card';
                if(t.excluded) card.classList.add('excluded');
                let html = `<span class="sorter-en">${t.tag}</span>`;
                if (t.trans) html += `<span class="sorter-cn">${t.trans}</span>`;
                card.innerHTML = html;
                card.onclick = () => toggleSorterTag(cat, index);
                wrapper.appendChild(card);
            });
            groupDiv.appendChild(wrapper);
            analysisDiv.appendChild(groupDiv);
        });
    }

    function toggleSorterTag(category, index) {
        if(lastSortedData[category] && lastSortedData[category][index]) {
            const tagObj = lastSortedData[category][index];
            tagObj.excluded = !tagObj.excluded;
            renderSorterResults(lastSortedData);
            updateSorterOutputText(lastSortedData);
        }
    }

    function updateSorterOutputText(resultStruct) {
        let fullText = "";
        let displayOrder = globalConfig.order.length > 0 ? globalConfig.order : Object.keys(resultStruct);
        const allCats = Object.keys(resultStruct);
        allCats.forEach(c => { if(!displayOrder.includes(c)) displayOrder.push(c); });
        displayOrder.forEach(cat => {
            const tags = resultStruct[cat];
            if (!tags) return;
            const activeTags = tags.filter(t => !t.excluded).map(t => t.tag);
            if (activeTags.length > 0) fullText += activeTags.join(', ') + ", \n";
        });
        document.getElementById('outputText').value = fullText;
    }

    // === Dictionary é€»è¾‘ ===
    async function loadDictionaryStructure() {
        const grid = document.getElementById('tagsGrid');
        grid.innerHTML = '<div style="color:#888; padding:20px; text-align:center;">æ­£åœ¨è¯»å–ç›®å½•ç»“æ„...</div>';
        try {
            const res = await fetch('/api/get_dictionary_structure');
            const data = await res.json();
            if (data.status === 'success') {
                dictionaryStructure = data.structure;
                mergeLocalDataToStructure();
                renderMajorTabs();
                grid.innerHTML = '<div style="color:#666; padding:20px; text-align:center;">â† è¯·é€‰æ‹©å·¦ä¾§åˆ†ç±»æŸ¥çœ‹æ ‡ç­¾</div>';
            } else grid.innerHTML = '<div style="color:red; padding:20px; text-align:center;">æ•°æ®ä¸ºç©º</div>';
        } catch(e) { grid.innerHTML = 'ç½‘ç»œé”™è¯¯: ' + e; }
    }

    function mergeLocalDataToStructure() {
        fullDictionaryStructure = JSON.parse(JSON.stringify(dictionaryStructure));
        const local = getLocalData();
        local.added.forEach(item => {
            if (!fullDictionaryStructure[item.c]) fullDictionaryStructure[item.c] = [];
            if (!fullDictionaryStructure[item.c].includes(item.s)) {
                fullDictionaryStructure[item.c].push(item.s);
                fullDictionaryStructure[item.c].sort();
            }
        });
    }

    function renderMajorTabs() {
        const container = document.getElementById('majorTabsContainer');
        container.innerHTML = '';
        const categories = Object.keys(fullDictionaryStructure).sort();
        categories.forEach((cat, index) => {
            const tab = document.createElement('div');
            tab.className = 'major-tab';
            tab.innerText = cat;
            tab.onclick = () => selectMajor(cat, tab);
            
            // æ‹–æ‹½
            tab.draggable = true;
            tab.addEventListener('dragstart', handleDragStart);
            tab.addEventListener('dragover', handleDragOver);
            tab.addEventListener('drop', handleDrop);
            tab.addEventListener('dragend', handleDragEnd);
            tab.addEventListener('contextmenu', (e) => handleRightClick(e, 'major', cat));

            container.appendChild(tab);
            if (index === 0 && !currentMajor) selectMajor(cat, tab);
        });
        const addBtn = document.createElement('div');
        addBtn.className = 'major-tab-add';
        addBtn.innerText = '+';
        addBtn.title = "æ–°å»ºå¤§ç±»";
        addBtn.onclick = () => openModal('new_major');
        container.appendChild(addBtn);
    }

    // æ‹–æ‹½æ’åº (æœ¬åœ°ç‰ˆï¼Œä¸ä¿å­˜åˆ°æœåŠ¡å™¨)
    let dragSrcEl = null;
    function handleDragStart(e) {
        this.classList.add('dragging');
        dragSrcEl = this;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
    }
    function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; }
    function handleDrop(e) {
        if (e.stopPropagation) e.stopPropagation();
        if (dragSrcEl !== this) {
            const container = document.getElementById('majorTabsContainer');
            // æ³¨æ„æ’é™¤æœ€åçš„åŠ å·æŒ‰é’®
            const allTabs = [...container.querySelectorAll('.major-tab')];
            const srcIndex = allTabs.indexOf(dragSrcEl);
            const targetIndex = allTabs.indexOf(this);
            if (srcIndex < targetIndex) container.insertBefore(dragSrcEl, this.nextSibling);
            else container.insertBefore(dragSrcEl, this);
            
            // ä¿å­˜é¡ºåºåˆ° LocalStorage (æš‚æœªå®ç°å¤æ‚é¡ºåºæŒä¹…åŒ–ï¼Œä»…å½“å‰ä¼šè¯æœ‰æ•ˆ)
        }
        return false;
    }
    function handleDragEnd(e) { this.classList.remove('dragging'); }

    function selectMajor(catName, domElement) {
        currentMajor = catName;
        document.querySelectorAll('.major-tab').forEach(el => el.classList.remove('active'));
        if(domElement) domElement.classList.add('active');
        else {
            const tabs = document.querySelectorAll('.major-tab');
            for(let t of tabs) if(t.innerText === catName) t.classList.add('active');
        }
        renderMinorSidebar(catName);
    }

    function renderMinorSidebar(catName) {
        const container = document.getElementById('minorSidebar');
        container.innerHTML = '';
        const addBtn = document.createElement('div');
        addBtn.className = 'minor-item-add';
        addBtn.innerHTML = '<span>+ æ–°å»ºå°ç±»</span>';
        addBtn.onclick = () => openModal('new_minor');
        container.appendChild(addBtn);
        const minors = fullDictionaryStructure[catName] || [];
        minors.forEach((sub, index) => {
            const item = document.createElement('div');
            item.className = 'minor-item';
            item.innerText = sub;
            item.onclick = () => selectMinor(sub, item);
            item.addEventListener('contextmenu', (e) => handleRightClick(e, 'minor', sub, catName));
            container.appendChild(item);
        });
    }

    async function selectMinor(subName, domElement) {
        currentMinor = subName;
        document.querySelectorAll('.minor-item').forEach(el => el.classList.remove('active'));
        if(domElement) domElement.classList.add('active');
        const title = document.getElementById('currentSectionTitle');
        title.innerText = `${currentMajor} > ${subName}`;
        const container = document.getElementById('tagsGrid');
        container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#888; padding:20px;">æ­£åœ¨åŠ è½½æ ‡ç­¾...</div>';
        
        let serverTags = [];
        try {
            const res = await fetch('/api/get_category_tags', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cat: currentMajor, sub: subName })
            });
            const data = await res.json();
            serverTags = data.tags;
        } catch(e) { console.error("åŠ è½½æœåŠ¡å™¨æ•°æ®å¤±è´¥", e); }

        const local = getLocalData();
        const localTags = local.added.filter(item => item.c === currentMajor && item.s === subName).map(item => ({
            tag: item.t, trans: item.zh, isLocal: true
        }));

        let allTags = [...serverTags, ...localTags];
        allTags = allTags.filter(t => !local.deleted.includes(t.tag));
        renderTagsGrid(allTags, false);
    }

    function renderTagsGrid(tagsList, isTruncated) {
        const container = document.getElementById('tagsGrid');
        container.innerHTML = '';
        if (!tagsList || tagsList.length === 0) {
            container.innerHTML = '<div style="grid-column:1/-1; color:#666; text-align:center;">æš‚æ— æ•°æ®</div>';
            return;
        }
        const fragment = document.createDocumentFragment();
        tagsList.forEach(item => {
            translationCache[item.tag.toLowerCase()] = item.trans;
            const card = document.createElement('div');
            card.className = 'dict-card';
            if (item.isLocal) card.classList.add('user-custom');
            card.addEventListener('contextmenu', (e) => handleRightClick(e, 'tag', item.tag));
            const enSpan = document.createElement('div');
            enSpan.className = 'dict-en';
            enSpan.innerText = item.tag;
            const cnSpan = document.createElement('div');
            if (item.trans && item.trans.trim() !== "") {
                cnSpan.className = 'dict-cn';
                cnSpan.innerText = item.trans;
            } else {
                cnSpan.className = 'dict-cn empty';
                cnSpan.innerText = '(æš‚æ— ç¿»è¯‘)';
            }
            card.appendChild(enSpan);
            card.appendChild(cnSpan);
            card.onclick = () => addTagToBuilder(item.tag);
            fragment.appendChild(card);
        });
        container.appendChild(fragment);
    }

    // === æœ¬åœ°åˆ é™¤ ===
    function handleRightClick(e, type, target, parent) {
        e.preventDefault();
        const menu = document.getElementById('contextMenu');
        menu.style.display = 'block';
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
        let html = '';
        if (type === 'tag') html += `<div class="ctx-item delete" onclick="deleteLocalItem('tag', '${target}')">ğŸ—‘ï¸ åˆ é™¤æ­¤æ ‡ç­¾ (æœ¬åœ°)</div>`;
        menu.innerHTML = html;
    }

    function deleteLocalItem(type, target) {
        if (!confirm("ç¡®å®šè¦åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­å±è”½æ­¤æ ‡ç­¾å—ï¼Ÿ")) return;
        const local = getLocalData();
        const index = local.added.findIndex(item => item.t === target);
        if (index > -1) {
            local.added.splice(index, 1);
            localStorage.setItem(STORAGE_KEY_TAGS, JSON.stringify(local.added));
        } else {
            if (!local.deleted.includes(target)) {
                local.deleted.push(target);
                localStorage.setItem(STORAGE_KEY_DELETED, JSON.stringify(local.deleted));
            }
        }
        alert("å·²åˆ é™¤/å±è”½");
        selectMinor(currentMinor);
    }

    // === æœ¬åœ°ä¿å­˜ ===
    function saveTagDataLocal() {
        const tag = document.getElementById('modalTag').value.trim().toLowerCase();
        const trans = document.getElementById('modalTrans').value.trim();
        const cat = document.getElementById('modalCat').value.trim();
        const sub = document.getElementById('modalSub').value.trim();

        if (!tag || !cat || !sub) { alert("è¯·å¡«å†™å®Œæ•´ï¼"); return; }

        const local = getLocalData();
        const exists = local.added.some(item => item.t === tag);
        if (exists) {
            local.added = local.added.map(item => item.t === tag ? {t:tag, zh:trans, c:cat, s:sub} : item);
        } else {
            local.added.push({t:tag, zh:trans, c:cat, s:sub});
        }
        const delIndex = local.deleted.indexOf(tag);
        if(delIndex > -1) {
            local.deleted.splice(delIndex, 1);
            localStorage.setItem(STORAGE_KEY_DELETED, JSON.stringify(local.deleted));
        }
        localStorage.setItem(STORAGE_KEY_TAGS, JSON.stringify(local.added));
        alert("å·²ä¿å­˜åˆ°æœ¬åœ°æµè§ˆå™¨ï¼");
        closeModal();
        mergeLocalDataToStructure();
        renderMajorTabs();
        if (currentMajor === cat && currentMinor === sub) selectMinor(sub); 
        else { selectMajor(cat); setTimeout(() => selectMinor(sub), 100); }
    }

    // === è¾…åŠ© ===
    function syncTagsFromInput() {
        const input = document.getElementById('builderInput');
        const display = document.getElementById('selectedTagsDisplay');
        const rawText = input.value;
        const tags = rawText.split(/[,\n]+/).map(t => t.trim()).filter(t => t);
        display.innerHTML = '';
        if (tags.length === 0) { display.innerHTML = '<div class="empty-tip">å·²é€‰æ ‡ç­¾å°†æ˜¾ç¤ºåœ¨è¿™é‡Œï¼Œç‚¹å‡»å³å¯åˆ é™¤...</div>'; return; }
        tags.forEach((tag, index) => {
            const chip = document.createElement('div');
            chip.className = 'selected-tag-chip';
            const trans = translationCache[tag.toLowerCase()] || '';
            let html = `<span class="chip-en">${tag}</span>`;
            if (trans) html += `<span class="chip-cn">${trans}</span>`;
            chip.innerHTML = html;
            chip.onclick = () => removeTagByIndex(index);
            display.appendChild(chip);
        });
        display.scrollTop = display.scrollHeight;
    }
    function removeTagByIndex(indexToRemove) {
        const input = document.getElementById('builderInput');
        let tags = input.value.split(/[,\n]+/).map(t => t.trim()).filter(t => t);
        tags.splice(indexToRemove, 1);
        const inputVal = tags.length > 0 ? tags.join(', ') + ', ' : '';
        input.value = inputVal;
        syncTagsFromInput();
    }
    function addTagToBuilder(tag) {
        const input = document.getElementById('builderInput');
        let currentVal = input.value.trim();
        if (currentVal.length > 0 && !currentVal.endsWith(',')) currentVal += ', ';
        else if (currentVal.length > 0 && currentVal.endsWith(',')) currentVal += ' ';
        input.value = currentVal + tag + ', ';
        syncTagsFromInput();
        input.scrollTop = input.scrollHeight;
    }
    function clearBuilder() { document.getElementById('builderInput').value = ''; syncTagsFromInput(); }
    function copyBuilder() {
        const textarea = document.getElementById('builderInput');
        textarea.select(); document.execCommand('copy');
        const btn = event.target; const originalText = btn.innerText;
        btn.innerText = "å·²å¤åˆ¶!"; btn.style.background = "#69f0ae";
        setTimeout(() => { btn.innerText = originalText; btn.style.background = ""; }, 1000);
    }
    
    function openModal(mode) {
        const modal = document.getElementById('editModal');
        const modalTitle = document.getElementById('modalTitle');
        const catInput = document.getElementById('modalCat');
        const subInput = document.getElementById('modalSub');
        modal.classList.add('show');
        catInput.value = ''; subInput.value = '';
        document.getElementById('modalTag').value = '';
        document.getElementById('modalTrans').value = '';
        catInput.readOnly = false;
        
        const catList = document.getElementById('catList');
        catList.innerHTML = '';
        const categories = Object.keys(fullDictionaryStructure).sort();
        categories.forEach(cat => {
            const opt = document.createElement('option'); opt.value = cat; catList.appendChild(opt);
        });

        if (mode === 'new_major') { modalTitle.innerText = "âœ¨ æ–°å»ºå¤§ç±» (æœ¬åœ°)"; catInput.focus(); }
        else if (mode === 'new_minor') {
            modalTitle.innerText = "âœ¨ æ–°å»ºå°ç±» (æœ¬åœ°)";
            if (currentMajor) { catInput.value = currentMajor; catInput.readOnly = true; }
            subInput.focus();
        } else {
            modalTitle.innerText = "âœ¨ æ–°å¢ / ä¿®æ”¹ Tag (æœ¬åœ°)";
            if (currentMajor) catInput.value = currentMajor;
            if (currentMinor) subInput.value = currentMinor;
        }
        updateSubList();
    }
    function closeModal() { document.getElementById('editModal').classList.remove('show'); }
    function updateSubList() {
        const catVal = document.getElementById('modalCat').value;
        const subList = document.getElementById('subList');
        subList.innerHTML = '';
        if (fullDictionaryStructure[catVal]) {
            fullDictionaryStructure[catVal].forEach(sub => {
                const opt = document.createElement('option'); opt.value = sub; subList.appendChild(opt);
            });
        }
    }
    async function performSearch() {
        const query = document.getElementById('searchInput').value.trim();
        const container = document.getElementById('tagsGrid');
        const title = document.getElementById('currentSectionTitle');
        if (!query) { alert("è¯·è¾“å…¥æœç´¢å†…å®¹å–µï¼"); return; }
        title.innerText = `ğŸ” æœç´¢ç»“æœ: "${query}"`;
        container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#888; padding:20px;">æ­£åœ¨æœç´¢...</div>';
        document.querySelectorAll('.minor-item').forEach(el => el.classList.remove('active'));
        try {
            const res = await fetch('/api/search_tags', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            });
            const data = await res.json();
            renderTagsGrid(data.results, false);
            if (data.results.length === 0) container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#888; padding:20px;">æœªæ‰¾åˆ°ç›¸å…³æ ‡ç­¾ ğŸ±</div>';
        } catch(e) { container.innerHTML = `<div style="color:red; grid-column:1/-1; text-align:center;">æœç´¢å‡ºé”™: ${e}</div>`; }
    }
</script>

</body>
</html>